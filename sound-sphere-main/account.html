<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SoundSphere - Account</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-color: #f8f9fa;
      --sidebar-bg: #ffffff;
      --primary: #6c5ce7;
      --primary-light: #e9e7ff;
      --text-color: #343a40;
      --text-light: #6c757d;
      --border-color: #dee2e6;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; }
    body { display: flex; height: 100vh; background: var(--bg-color); overflow: hidden; }
    
    /* --- Sidebar  --- */
    aside { width: 220px; background: var(--sidebar-bg); padding: 1.5rem; display: flex; flex-direction: column; border-right: 1px solid var(--border-color); flex-shrink: 0; }
    .brand { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 2rem; }
    .logo { width: 40px; height: auto; }
    .brand-name { font-size: 1.25rem; font-weight: 700; color: #2d9cdb; }
    nav { display: flex; flex-direction: column; gap: 0.5rem; }
    nav h4 { margin: 1.5rem 0 0.5rem; font-weight: 600; font-size: 0.8rem; color: #888; text-transform: uppercase; }
    nav a { text-decoration: none; color: var(--text-color); padding: 0.75rem 1rem; display: flex; align-items: center; gap: 0.75rem; border-radius: 8px; transition: all 0.2s ease; font-weight: 500;}
    nav a.active { background: var(--primary); color: white; font-weight: 600; }
    nav a:hover:not(.active) { background: var(--bg-color); }
    
    /* --- Main Content & Layout --- */
    main { flex: 1; padding: 2.5rem; overflow-y: auto; }
    .container { max-width: 900px; margin: 0 auto; }
    .page-header h1 { font-size: 2.25rem; font-weight: 700; color: var(--text-color); }
    .page-header p { font-size: 1rem; color: var(--text-light); margin-top: 0.25rem; }

    .card { background: #fff; padding: 2rem; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.05); margin-top: 2rem; }
    .form-group { display: flex; flex-direction: column; margin-bottom: 1.5rem; }
    label { margin-bottom: 0.5rem; font-weight: 600; font-size: 0.9rem; }
    input { width: 100%; padding: 0.8rem 1rem; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; }
    input:disabled { background-color: #f1f3f5; }
    .form-actions { display: flex; justify-content: flex-end; margin-top: 1rem; }
    .btn { background: var(--primary); color: #fff; padding: 0.75rem 1.5rem; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.9rem; }
    .btn:disabled { background: #ccc; cursor: not-allowed; }

    /* --- CSS FOR UPLOADED TRACKS SECTION --- */
    .section-header {
        padding-bottom: 1rem;
        margin-bottom: 1.5rem;
        border-bottom: 1px solid var(--border-color);
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--text-color);
    }
    .track-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    .track-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem;
        border-radius: 8px;
        transition: background-color 0.2s ease;
    }
    .track-item:hover {
        background-color: var(--bg-color);
    }
    .track-info {
        display: flex;
        align-items: center;
        gap: 1rem;
    }
    .track-icon {
        font-size: 1.5rem;
        color: var(--primary);
    }
    .track-title {
        font-weight: 500;
        color: var(--text-color);
    }
    .track-artist {
        font-size: 0.9rem;
        color: var(--text-light);
    }
    .no-tracks-message {
        padding: 1rem;
        color: var(--text-light);
        text-align: center;
    }

  </style>
</head>
<body>
  <aside>
    <div class="brand"><img src="Vector.png" alt="SoundSphere Logo" class="logo" /><span class="brand-name">SoundSphere</span></div>
    <nav>
      <a href="Home.html"><span>üè†</span><span>Home</span></a>
      <h4>More</h4>
      <a href="settings.html"><span>‚öôÔ∏è</span><span>Setting</span></a>
      <a href="account.html" class="active"><span>üë§</span><span>Account</span></a>
      <a href="upload.html"><span>‚¨ÜÔ∏è</span><span>Upload</span></a>
      <a href="#" id="logoutBtn"><span>üö™</span><span>Logout</span></a>
    </nav>
  </aside>

  <main>
    <div class="container">
        <div class="page-header">
            <h1>My Account</h1>
            <p>View and manage your profile and uploaded music.</p>
        </div>
        
        <!-- Profile Update Card -->
        <div class="card">
            <form id="accountForm">
                <div class="form-group"><label for="email">Email Address</label><input type="email" id="email" disabled /></div>
                <div class="form-group"><label for="username">Username</label><input type="text" id="username" required /></div>
                <div class="form-actions"><button type="submit" class="btn" id="updateBtn">Update Profile</button></div>
            </form>
        </div>

        <!-- UPLOADED TRACKS SECTION -->
        <div class="card">
            <h2 class="section-header">My Uploaded Tracks</h2>
            
            <div>
                <h3>Public Tracks</h3>
                <ul class="track-list" id="publicTracksList">
                    <!-- Public tracks will be injected here by JS -->
                </ul>
            </div>
            
            <div style="margin-top: 2rem;">
                <h3>Private Tracks</h3>
                <ul class="track-list" id="privateTracksList">
                    <!-- Private tracks will be injected here by JS -->
                </ul>
            </div>
        </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const supabaseUrl = 'https://tqttpbhspgqwniwaokqh.supabase.co'; 
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRxdHRwYmhzcGdxd25pd2Fva3FoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA1MDM2MzksImV4cCI6MjA2NjA3OTYzOX0.q-R66Cb1qYx-0pCkKqy9bBE4BXJwcu4JN8Sv4XsgeiE'; // <-- Paste your Supabase Anon Key here
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
    
    const accountForm = document.getElementById('accountForm');
    const updateBtn = document.getElementById('updateBtn');
    const emailInput = document.getElementById('email');
    const usernameInput = document.getElementById('username');
    const logoutBtn = document.getElementById('logoutBtn');
    // --- ELEMENT SELECTION ---
    const publicTracksList = document.getElementById('publicTracksList');
    const privateTracksList = document.getElementById('privateTracksList');
    
    let currentUser = null;

    async function loadPageData() {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
            window.location.replace('SignIn.html');
            return;
        }
        currentUser = user;
        
        
        await Promise.all([
            loadProfile(),
            loadUserMusic()
        ]);
    }

    async function loadProfile() {
        emailInput.value = currentUser.email;
        const { data: profile, error } = await supabase
            .from('profiles')
            .select('username')
            .eq('id', currentUser.id)
            .single();

        if (error) console.error('Error fetching profile:', error);
        else if (profile) usernameInput.value = profile.username || '';
    }

    // --- FUNCTION TO LOAD AND DISPLAY MUSIC ---
    async function loadUserMusic() {
        // Fetch all music belonging to the current user
        const { data: tracks, error } = await supabase
            .from('music')
            .select('track_title, artist_name, privacy')
            .eq('user_id', currentUser.id)
            .order('created_at', { ascending: false });
            
        if (error) {
            console.error('Error fetching user music:', error);
            return;
        }

        // Filter tracks into public and private
        const publicTracks = tracks.filter(track => track.privacy === 'public');
        const privateTracks = tracks.filter(track => track.privacy === 'private');

        // Render public tracks
        publicTracksList.innerHTML = ''; // Clear existing list
        if (publicTracks.length > 0) {
            publicTracks.forEach(track => {
                const li = document.createElement('li');
                li.className = 'track-item';
                li.innerHTML = `
                    <div class="track-info">
                        <span class="track-icon">üéµ</span>
                        <div>
                            <div class="track-title">${track.track_title}</div>
                            <div class="track-artist">${track.artist_name}</div>
                        </div>
                    </div>
                `;
                publicTracksList.appendChild(li);
            });
        } else {
            publicTracksList.innerHTML = '<li class="no-tracks-message">You have not uploaded any public tracks.</li>';
        }

        // Render private tracks
        privateTracksList.innerHTML = ''; 
        if (privateTracks.length > 0) {
            privateTracks.forEach(track => {
                const li = document.createElement('li');
                li.className = 'track-item';
                li.innerHTML = `
                    <div class="track-info">
                        <span class="track-icon">üîí</span>
                        <div>
                            <div class="track-title">${track.track_title}</div>
                            <div class="track-artist">${track.artist_name}</div>
                        </div>
                    </div>
                `;
                privateTracksList.appendChild(li);
            });
        } else {
            privateTracksList.innerHTML = '<li class="no-tracks-message">You have not uploaded any private tracks.</li>';
        }
    }

    // Handle profile update
    accountForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        updateBtn.disabled = true;
        updateBtn.textContent = 'Updating...';
        const newUsername = usernameInput.value.trim();

        const { error } = await supabase.from('profiles').update({ username: newUsername }).eq('id', currentUser.id);

        if (error) {
            alert('Error updating profile: ' + error.message);
        } else {
            alert('Profile updated successfully!');
            await supabase.auth.updateUser({ data: { username: newUsername } });
        }
        updateBtn.disabled = false;
        updateBtn.textContent = 'Update Profile';
    });

    logoutBtn.addEventListener('click', async () => {
        await supabase.auth.signOut();
        window.location.replace('SignIn.html');
    });

    document.addEventListener('DOMContentLoaded', loadPageData);
  </script>
</body>
</html>